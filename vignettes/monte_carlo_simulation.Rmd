---
title: "Monte-Carlo Simulation"
author: "Nima Ramezani"
date: "30/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(lubridate)
library(rbig)
library(rutils)
library(rvis)
library(rprom)
```

## Introduction

In the previous session, we learned how to run a random-walk simulation 
to estimate probability distribution over various statuses of the transition system.

As you can see, Random-walk simulation does not give any estimation of the future status of an individual case,
but returns the overall status probabilities for all cases.

In this article, we want to monitor the future of each individual case using Monte-Carlo simulation.
Assume that we are in a certain point in the time-line within the process and call it the **cutpoint time**.
Some cases have not started yet, some cases are in the middle of their lifetime and some have ended and
live cases can be at various statuses within the transitiopn system.
Now, let's stop a some point in time and try to predict future transitions for each case.
The Transition Matrix gives us a probability distribution for the next transition of each case.
The Monte-Carlo simulation starts with generating a destination for each case as well as a transition time 
based on the current status of each case.
This will generate a list of *status transition* events for all the live cases. 
After this step, each case will be in a different status and hence 
different probabiliy distributions and avergae transition times for the next transition.
Similarly, another transition is generated for each case and this iterative procedure continues until all the existing case reach the **END** status.

For the cases that start after the cutpoint time, the simulation engine can generate the case arrival events or 
use the actual case arrivals by keeping **START** transitions for the simulation engine to generate next transitions.
The former option is a pure prediction as it assumes we have no information of the future arrivals.

We used dataset `hospital_billing` from package eventdata for this study and 
choose column `activity` as the case status:

```{r feed_data}

hospital_df = eventdataR::hospital_billing %>% as.data.frame
tsobj = new('TRANSYS')
tsobj$feed.eventlog(hospital_df, 
                    caseID_col = 'case_id', 
                    status_col = 'activity',
                    startTime_col = 'timestamp')
```

The time range of the process is from `r tsobj$modelStart` until `r tsobj$modelEnd`.
We choose some time in the middle like `2013-07-01` and generate transitions from that time for the next two years.

Method `run.simulation` runs a Monte-Carlo simulation from the start date-time that you specify and 
returns generated transitions in a new event-log:

```{r montecarlo}
new_transitions = tsobj$run.simulation(start_dt = '2014-07-01', target_dt = '2015-07-01')
knitr::kable(new_transitions %>% head(20))
```

What you get is a list of future auto-generated transition events that happen after the simulation start date 
`2014-07-01`. 
These events represent one of the many ways that the process could have continued after the specified start date.
The simulation engine generates two values for each transition:

* Transition Target: 
  is determined based on the probability distribution for transition to the next targets given the current status of a case.

* Transition Time: time the cases linger at the source status before migrating to the next status.
  Transition time is by default generated as a random value with normal distribution with mean and standard deviation observed from the history of transitions of the type. 

<!-- For example, if we observed that  -->
<!--   transition from status **FIN**	to **RELEASE** has a mean value of `134,000 (sec)` and a standard deviation of    `1,405,000 (sec)`, it generates a random value from a normal distributin with the observed mean and standard deviation. -->

But are transition times really follow a normal distribution? 
Let's look at the distributions of the transition times in out transition system.
Function `plot_transition_time_histogram` can give you this visualization
(you will need to install packages `plotly` and `crosstalk`):

```{r tt_histogram}
if(!require(plotly)){install.packages('plotly')}
if(!require(crosstalk)){install.packages('crosstalk')}

tsobj %>% plot_transition_time_histogram(remove_outliers = TRUE)
```

Select a transition from the drop-down menu to see a histogram of the durations.
How many of them look like having a gaussian distribution?
You can see that most durations have a distribution similar to exponential.
That's why selecting normal distribution in generating transition times leads may to unrealistic results.

You can generate transition times based on exponential distribution by passing `exp` to argument `family`.



You can change the time generator engine of the simulator and set it 
to another existing function or even your custom function.
By default the simulator uses `function markovchain_transition_time_estimator` 
to generate predicted transition durations. This function is called multiple times during the simulation.
The simulator engine passes three inputs to this function:

* `histobj`: an object of class `TranSys`. `histobj` will directly be passed to this function. 
  During the simulation, the simulator engine changes the current time from `start_dt` to the `target_dt`. 
  The `histobj` object, contains process history data upto the current time.

* `input`: dataframe containig the list of transition events up to the current time.

* `curent_time`: the value of the current time

The output of this function must be a dataframe with added column `pred_duration` 
containing the estimated or predicted durations.
  
In the next study, we will learn how to generate features and label to build training data for predicting the next transition status.